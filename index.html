<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Koordynacji</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23006B61%22>❤</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Charm:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8faf9; overflow: hidden; }
        .font-section-title { font-family: 'Charm', cursive; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Style Paneli */
        .panel-style {
            background: white;
            border-radius: 30px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
            border-bottom: 4px solid #006B61;
        }

        .content-panel-style {
            background: white;
            border-radius: 50px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            border: 1px solid #f3f4f6;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #006B61; border-radius: 10px; }
        
        .tab-button {
            transition: all 0.3s ease;
            border-radius: 9999px;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
            padding: 12px 24px;
        }
        .tab-button-active { background-color: #006B61; color: white; box-shadow: 0 10px 15px -3px rgba(0, 107, 97, 0.3); }
        .tab-button-inactive { background-color: white; color: #9CA3AF; border: 1px solid #E5E7EB; }
        .tab-button-inactive:hover { background-color: #f3f4f6; color: #006B61; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const coordinators = ['Oliwia Giermanowska', 'Klaudia Iwaneczko', 'Emilia Jabłońska', 'Natalia Kopera', 'Anna Metlerska', 'Patrycja Szaton'];
        
        // --- TWOJE API (Backend Wersja 10) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxfOxVzFw7VPwY88WNySfn2Zo18STi8znNWyp2Rj-WfhYYu_Hg89_du84aaf-oEQkeBzg/exec";

        // --- KOMPONENT: KALENDARZ ---
        const CalendarWidget = ({ activeTab }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDay, setSelectedDay] = useState(new Date());
            const [patterns, setPatterns] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedCoord, setSelectedCoord] = useState('WSZYSCY');

            useEffect(() => {
                setLoading(true);
                fetch(`${SCRIPT_URL}?action=getSchedule`)
                    .then(res => res.json())
                    .then(data => { 
                        setPatterns(Array.isArray(data) ? data : []); 
                        setLoading(false); 
                    })
                    .catch(err => { 
                        setPatterns([]); 
                        setLoading(false); 
                    });
            }, []);

            const daysOfWeek = ['Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'So', 'Nd'];
            const monthNames = ['Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec', 'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'];

            const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const getFirstDayOfMonth = (date) => {
                let day = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
                return day === 0 ? 6 : day - 1; 
            };

            const daysInMonth = getDaysInMonth(currentDate);
            const firstDay = getFirstDayOfMonth(currentDate);
            
            const getEventsForDay = (dayNumber) => {
                if (!dayNumber || !patterns) return [];
                const checkDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), dayNumber);
                const dayOfWeekJS = checkDate.getDay(); 
                
                return patterns.filter(p => {
                    if (!p || !p.role || !Array.isArray(p.days)) return false;

                    const role = p.role.toLowerCase();
                    const isCoord = role.includes('koordynator');
                    let roleMatch = false;
                    
                    if (activeTab === 'koordynatorzy') {
                        roleMatch = isCoord;
                        if (selectedCoord !== 'WSZYSCY' && p.name !== selectedCoord) roleMatch = false;
                    } else if (activeTab === 'personel') {
                        roleMatch = !isCoord; // Tylko personel, bez koordynatorów
                    } else if (activeTab === 'pacjenci') {
                        roleMatch = false; // Pusto
                    }

                    const dayMatch = p.days.includes(dayOfWeekJS);
                    return roleMatch && dayMatch;
                });
            };

            const getShiftType = (hoursString) => {
                try {
                    const startHour = parseInt(hoursString.trim().split(':')[0]);
                    return startHour >= 12 ? 'pm' : 'am';
                } catch (e) { return 'am'; }
            };

            const daysArray = [];
            for (let i = 0; i < firstDay; i++) daysArray.push(null);
            for (let i = 1; i <= daysInMonth; i++) daysArray.push(i);

            const isSelected = (day) => day === selectedDay.getDate() && currentDate.getMonth() === selectedDay.getMonth();
            const allEvents = getEventsForDay(selectedDay.getDate());
            const morningShift = allEvents.filter(e => getShiftType(e.hours) === 'am');
            const afternoonShift = allEvents.filter(e => getShiftType(e.hours) === 'pm');

            return (
                <div className="flex flex-col md:flex-row gap-6 h-full animate-fadeIn">
                    <div className="content-panel-style p-8 flex-1">
                        <div className="flex flex-col gap-4 mb-6">
                            <div className="flex justify-between items-center">
                                <h2 className="text-3xl font-black text-[#006B61] uppercase tracking-widest">
                                    {monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}
                                </h2>
                                <div className="flex gap-2">
                                    <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="p-2 rounded-full hover:bg-gray-100"><i data-lucide="chevron-left" className="w-6 h-6 text-[#006B61]"></i></button>
                                    <button onClick={() => { setCurrentDate(new Date()); setSelectedDay(new Date()); }} className="px-4 py-2 rounded-full bg-[#006B61] text-white text-xs font-bold uppercase tracking-widest">Dziś</button>
                                    <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="p-2 rounded-full hover:bg-gray-100"><i data-lucide="chevron-right" className="w-6 h-6 text-[#006B61]"></i></button>
                                </div>
                            </div>
                            
                            {activeTab === 'koordynatorzy' && (
                                <div className="bg-gray-50 p-2 rounded-2xl flex items-center gap-2 border border-gray-200 w-full md:w-2/3 animate-fadeIn">
                                    <span className="text-[10px] font-black uppercase text-gray-400 ml-2">Wybierz osobę:</span>
                                    <select value={selectedCoord} onChange={(e) => setSelectedCoord(e.target.value)} className="bg-transparent font-bold text-[#006B61] text-sm outline-none flex-1 cursor-pointer">
                                        <option value="WSZYSCY">WSZYSCY</option>
                                        {coordinators.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                            )}
                        </div>

                        <div className="grid grid-cols-7 gap-4 text-center mb-4">
                            {daysOfWeek.map(day => <div key={day} className="text-gray-400 font-black text-xs uppercase tracking-widest">{day}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-2 justify-items-center">
                            {daysArray.map((day, index) => {
                                const events = getEventsForDay(day);
                                const hasEvents = events.length > 0;
                                return (
                                    <div key={index} 
                                        onClick={() => day && setSelectedDay(new Date(currentDate.getFullYear(), currentDate.getMonth(), day))}
                                        className={`w-14 h-14 flex flex-col items-center justify-center rounded-2xl text-lg font-bold transition-all relative
                                        ${day === null ? '' : 'cursor-pointer hover:bg-[#C9D9B6]/50'}
                                        ${day && isSelected(day) ? 'bg-[#006B61] text-white shadow-lg scale-105' : 'text-gray-700'}
                                    `}>
                                        {day}
                                        {hasEvents && day && !isSelected(day) && (
                                            <div className="flex gap-1 mt-1">
                                                {events.slice(0, 3).map((_, i) => (
                                                    <div key={i} className="w-1.5 h-1.5 rounded-full bg-[#006B61]"></div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <div className="content-panel-style p-8 w-full md:w-96 flex flex-col">
                        <h3 className="text-xl font-black text-gray-800 mb-6 border-b pb-4">
                            {selectedDay.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', weekday: 'long' })}
                        </h3>
                        
                        <div className="flex-1 overflow-y-auto custom-scrollbar space-y-6">
                            {loading ? (
                                <p className="text-gray-400 italic text-sm">Ładowanie grafiku...</p>
                            ) : activeTab === 'pacjenci' ? (
                                <div className="text-center py-20 opacity-50">
                                    <i data-lucide="wrench" className="w-10 h-10 mx-auto mb-2 text-gray-300"></i>
                                    <p className="text-xs font-bold uppercase text-gray-400">Moduł w przygotowaniu</p>
                                </div>
                            ) : allEvents.length === 0 ? (
                                <div className="text-center py-10 opacity-50">
                                    <i data-lucide="coffee" className="w-10 h-10 mx-auto mb-2 text-gray-300"></i>
                                    <p className="text-xs font-bold uppercase text-gray-400">Brak dyżurów</p>
                                </div>
                            ) : (
                                <>
                                    {morningShift.length > 0 && (
                                        <div className="space-y-3">
                                            <p className="text-[10px] font-black uppercase tracking-widest text-amber-500 flex items-center gap-2">
                                                <i data-lucide="sun" className="w-4 h-4"></i> Zmiana Poranna
                                            </p>
                                            {morningShift.map((ev, idx) => (
                                                <div key={idx} className="bg-amber-50/50 p-4 rounded-2xl border border-amber-100 flex justify-between items-center hover:scale-105 transition-all">
                                                    <div>
                                                        <p className="font-bold text-gray-700 text-sm">{ev.name}</p>
                                                        <p className="text-[10px] text-gray-400 uppercase mt-1">{ev.role}</p>
                                                    </div>
                                                    <span className="text-[10px] font-black bg-white text-amber-600 px-2 py-1 rounded-md border border-amber-100 whitespace-nowrap">{ev.hours}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {afternoonShift.length > 0 && (
                                        <div className="space-y-3">
                                            <p className="text-[10px] font-black uppercase tracking-widest text-indigo-500 flex items-center gap-2">
                                                <i data-lucide="moon" className="w-4 h-4"></i> Zmiana Popołudniowa
                                            </p>
                                            {afternoonShift.map((ev, idx) => (
                                                <div key={idx} className="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100 flex justify-between items-center hover:scale-105 transition-all
