<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Koordynacji</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23006B61%22>❤</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Charm:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8faf9; overflow: hidden; }
        .font-section-title { font-family: 'Charm', cursive; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .panel-style {
            background: white;
            border-radius: 30px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
            border-bottom: 4px solid #006B61;
        }

        .content-panel-style {
            background: white;
            border-radius: 50px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            border: 1px solid #f3f4f6;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #006B61; border-radius: 10px; }
        
        .tab-button {
            transition: all 0.3s ease;
            border-radius: 9999px;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
            padding: 12px 24px;
        }
        .tab-button-active { background-color: #006B61; color: white; box-shadow: 0 10px 15px -3px rgba(0, 107, 97, 0.3); }
        .tab-button-inactive { background-color: white; color: #9CA3AF; border: 1px solid #E5E7EB; }
        .tab-button-inactive:hover { background-color: #f3f4f6; color: #006B61; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const coordinators = ['Oliwia Giermanowska', 'Klaudia Iwaneczko', 'Emilia Jabłońska', 'Natalia Kopera', 'Anna Metlerska', 'Patrycja Szaton'];
        
        // --- API URL (Backend Wersja 11) ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxfOxVzFw7VPwY88WNySfn2Zo18STi8znNWyp2Rj-WfhYYu_Hg89_du84aaf-oEQkeBzg/exec";

        // --- KALENDARZ (PANCERNY - NIE WYWALA BŁĘDÓW) ---
        const CalendarWidget = ({ activeTab }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDay, setSelectedDay] = useState(new Date());
            const [patterns, setPatterns] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedCoord, setSelectedCoord] = useState('WSZYSCY');

            useEffect(() => {
                setLoading(true);
                fetch(`${SCRIPT_URL}?action=getSchedule`)
                    .then(res => res.json())
                    .then(data => { 
                        // Zabezpieczenie: upewniamy się, że data to tablica
                        setPatterns(Array.isArray(data) ? data : []); 
                        setLoading(false); 
                    })
                    .catch(err => { 
                        console.error("Błąd pobierania grafiku:", err);
                        setPatterns([]); 
                        setLoading(false); 
                    });
            }, []);

            const daysOfWeek = ['Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'So', 'Nd'];
            const monthNames = ['Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec', 'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'];

            const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const getFirstDayOfMonth = (date) => {
                let day = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
                return day === 0 ? 6 : day - 1; 
            };

            // --- PANCERNA FUNKCJA FILTRUJĄCA ---
            const getEventsForDay = (dateObj) => {
                if (!dateObj || !patterns) return [];
                
                let dayIndex = dateObj.getDay();
                if (dayIndex === 0) dayIndex = 7;

                return patterns.filter(p => {
                    // Zabezpieczenie przed pustymi danymi w Excelu
                    if (!p || !Array.isArray(p.days)) return false;
                    
                    const role = String(p.role || '').toLowerCase();
                    const name = String(p.name || '');
                    const isCoord = role.includes('koordynator');
                    
                    let roleMatch = false;
                    if (activeTab === 'koordynatorzy') {
                        roleMatch = isCoord;
                        if (selectedCoord !== 'WSZYSCY' && !name.includes(selectedCoord)) roleMatch = false;
                    } else if (activeTab === 'personel') {
                        roleMatch = !isCoord; 
                    } else { 
                        roleMatch = false; // Pacjenci placeholder
                    }

                    return roleMatch && p.days.includes(dayIndex);
                });
            };

            const getShiftType = (hoursString) => {
                try {
                    // Zabezpieczenie przed brakiem godzin
                    const h = String(hoursString || '');
                    const startHour = parseInt(h.trim().split(':')[0]);
                    return startHour >= 12 ? 'pm' : 'am';
                } catch (e) { return 'am'; }
            };

            const daysInMonthCount = getDaysInMonth(currentDate);
            const firstDayIndex = getFirstDayOfMonth(currentDate);
            const daysArray = []; 
            for (let i = 0; i < firstDayIndex; i++) daysArray.push(null); 
            for (let i = 1; i <= daysInMonthCount; i++) daysArray.push(i);

            const isSelected = (day) => {
                return day === selectedDay.getDate() && currentDate.getMonth() === selectedDay.getMonth();
            };

            const allEvents = getEventsForDay(selectedDay);
            const morningShift = allEvents.filter(e => getShiftType(e.hours) === 'am');
            const afternoonShift = allEvents.filter(e => getShiftType(e.hours) === 'pm');

            return (
                <div className="flex flex-col md:flex-row gap-6 h-full animate-fadeIn">
                    <div className="content-panel-style p-8 flex-1">
                        <div className="flex flex-col gap-4 mb-6">
                            <div className="flex justify-between items-center">
                                <h2 className="text-3xl font-black text-[#006B61] uppercase tracking-wid
